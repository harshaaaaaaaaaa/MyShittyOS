#include <gui/graphics.h>

using namespace osfiles::common;
using namespace osfiles::drivers;
using namespace osfiles::gui;

// 8x8 bitmap font data (ASCII 32-127)
// Each character is 8 bytes, one byte per row
static const uint8_t font8x8[96][8] = {
    // Space (32)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ! (33)
    {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00},
    // " (34)
    {0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // # (35)
    {0x6C, 0xFE, 0x6C, 0x6C, 0xFE, 0x6C, 0x00, 0x00},
    // $ (36)
    {0x18, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x18, 0x00},
    // % (37)
    {0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00},
    // & (38)
    {0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00},
    // ' (39)
    {0x30, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ( (40)
    {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    // ) (41)
    {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    // * (42)
    {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
    // + (43)
    {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    // , (44)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    // - (45)
    {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    // . (46)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    // / (47)
    {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00},
    // 0 (48)
    {0x7C, 0xC6, 0xCE, 0xDE, 0xF6, 0xE6, 0x7C, 0x00},
    // 1 (49)
    {0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x7E, 0x00},
    // 2 (50)
    {0x7C, 0xC6, 0x06, 0x1C, 0x30, 0x66, 0xFE, 0x00},
    // 3 (51)
    {0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00},
    // 4 (52)
    {0x0C, 0x1C, 0x3C, 0x6C, 0xFE, 0x0C, 0x0C, 0x00},
    // 5 (53)
    {0xFE, 0xC0, 0xFC, 0x06, 0x06, 0xC6, 0x7C, 0x00},
    // 6 (54)
    {0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00},
    // 7 (55)
    {0xFE, 0xC6, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    // 8 (56)
    {0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00},
    // 9 (57)
    {0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00},
    // : (58)
    {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
    // ; (59)
    {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},
    // < (60)
    {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00},
    // = (61)
    {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
    // > (62)
    {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00},
    // ? (63)
    {0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00},
    // @ (64)
    {0x7C, 0xC6, 0xDE, 0xDE, 0xDC, 0xC0, 0x7C, 0x00},
    // A (65)
    {0x10, 0x38, 0x6C, 0xC6, 0xFE, 0xC6, 0xC6, 0x00},
    // B (66)
    {0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00},
    // C (67)
    {0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00},
    // D (68)
    {0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00},
    // E (69)
    {0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00},
    // F (70)
    {0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00},
    // G (71)
    {0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3E, 0x00},
    // H (72)
    {0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    // I (73)
    {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    // J (74)
    {0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00},
    // K (75)
    {0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00},
    // L (76)
    {0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00},
    // M (77)
    {0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00},
    // N (78)
    {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00},
    // O (79)
    {0x38, 0x6C, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00},
    // P (80)
    {0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00},
    // Q (81)
    {0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0x7C, 0x0E, 0x00},
    // R (82)
    {0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00},
    // S (83)
    {0x7C, 0xC6, 0xE0, 0x78, 0x0E, 0xC6, 0x7C, 0x00},
    // T (84)
    {0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x3C, 0x00},
    // U (85)
    {0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    // V (86)
    {0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00},
    // W (87)
    {0xC6, 0xC6, 0xD6, 0xFE, 0xFE, 0xEE, 0xC6, 0x00},
    // X (88)
    {0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00},
    // Y (89)
    {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x00},
    // Z (90)
    {0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00},
    // [ (91)
    {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    // \ (92)
    {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00},
    // ] (93)
    {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    // ^ (94)
    {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // _ (95)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE},
    // ` (96)
    {0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    // a (97)
    {0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0x76, 0x00},
    // b (98)
    {0xE0, 0x60, 0x60, 0x7C, 0x66, 0x66, 0xDC, 0x00},
    // c (99)
    {0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00},
    // d (100)
    {0x1C, 0x0C, 0x0C, 0x7C, 0xCC, 0xCC, 0x76, 0x00},
    // e (101)
    {0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00},
    // f (102)
    {0x38, 0x6C, 0x60, 0xF0, 0x60, 0x60, 0xF0, 0x00},
    // g (103)
    {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8},
    // h (104)
    {0xE0, 0x60, 0x6C, 0x76, 0x66, 0x66, 0xE6, 0x00},
    // i (105)
    {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    // j (106)
    {0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C},
    // k (107)
    {0xE0, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0xE6, 0x00},
    // l (108)
    {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    // m (109)
    {0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xC6, 0x00},
    // n (110)
    {0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x00},
    // o (111)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    // p (112)
    {0x00, 0x00, 0xDC, 0x66, 0x66, 0x7C, 0x60, 0xF0},
    // q (113)
    {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0x1E},
    // r (114)
    {0x00, 0x00, 0xDC, 0x76, 0x66, 0x60, 0xF0, 0x00},
    // s (115)
    {0x00, 0x00, 0x7C, 0xC0, 0x7C, 0x06, 0xFC, 0x00},
    // t (116)
    {0x10, 0x30, 0x7C, 0x30, 0x30, 0x34, 0x18, 0x00},
    // u (117)
    {0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00},
    // v (118)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00},
    // w (119)
    {0x00, 0x00, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00},
    // x (120)
    {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00},
    // y (121)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0xFC},
    // z (122)
    {0x00, 0x00, 0xFE, 0x8C, 0x18, 0x32, 0xFE, 0x00},
    // { (123)
    {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},
    // | (124)
    {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00},
    // } (125)
    {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},
    // ~ (126)
    {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // DEL (127) - blank
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};

void Font::DrawChar(VideoGraphicsArray *vga, int32_t x, int32_t y, char c,
                    uint8_t color) {
  if (c < 32 || c > 127)
    c = '?';

  int index = c - 32;

  for (int row = 0; row < 8; row++) {
    uint8_t rowData = font8x8[index][row];
    for (int col = 0; col < 8; col++) {
      if (rowData & (0x80 >> col)) {
        vga->PutPixel(x + col, y + row, color);
      }
    }
  }
}

void Font::DrawString(VideoGraphicsArray *vga, int32_t x, int32_t y,
                      const char *str, uint8_t color) {
  int32_t cursorX = x;

  while (*str) {
    if (*str == '\n') {
      y += 8;
      cursorX = x;
    } else {
      DrawChar(vga, cursorX, y, *str, color);
      cursorX += 8;
    }
    str++;
  }
}

uint32_t Font::GetCharWidth() { return 8; }

uint32_t Font::GetCharHeight() { return 8; }

uint32_t Font::GetStringWidth(const char *str) {
  uint32_t width = 0;
  while (*str) {
    if (*str != '\n')
      width += 8;
    str++;
  }
  return width;
}

// Widget base class implementation
Widget::Widget(int32_t x, int32_t y, int32_t w, int32_t h, uint8_t bgColor) {
  this->x = x;
  this->y = y;
  this->width = w;
  this->height = h;
  this->backgroundColor = bgColor;
  this->visible = true;
  this->focused = false;
}

Widget::~Widget() {}

void Widget::Draw(VideoGraphicsArray *vga) {
  if (!visible)
    return;
  vga->FillRect(x, y, width, height, backgroundColor);
}

void Widget::OnMouseDown(int32_t mx, int32_t my, uint8_t button) {}

void Widget::OnMouseUp(int32_t mx, int32_t my, uint8_t button) {}

void Widget::OnMouseMove(int32_t mx, int32_t my) {}

void Widget::OnKeyDown(char c) {}

bool Widget::Contains(int32_t px, int32_t py) {
  return px >= x && px < x + width && py >= y && py < y + height;
}

void Widget::SetVisible(bool v) { visible = v; }

bool Widget::IsVisible() { return visible; }

void Widget::SetPosition(int32_t newX, int32_t newY) {
  x = newX;
  y = newY;
}

void Widget::GetPosition(int32_t *outX, int32_t *outY) {
  *outX = x;
  *outY = y;
}

void Widget::GetSize(int32_t *outW, int32_t *outH) {
  *outW = width;
  *outH = height;
}

// Button implementation
Button::Button(int32_t x, int32_t y, int32_t w, int32_t h, const char *label)
    : Widget(x, y, w, h, VGA_BUTTON) {
  this->label = label;
  this->textColor = VGA_WHITE;
  this->hoverColor = VGA_BUTTON_HOVER;
  this->hovered = false;
  this->pressed = false;
  this->clickHandler = 0;
}

Button::~Button() {}

void Button::Draw(VideoGraphicsArray *vga) {
  if (!visible)
    return;

  uint8_t bgColor = hovered ? hoverColor : backgroundColor;
  if (pressed)
    bgColor = VGA_DARK_GRAY;

  // Draw button background
  vga->FillRect(x, y, width, height, bgColor);

  // Draw border
  vga->DrawRect(x, y, width, height, VGA_WHITE);

  // Draw 3D effect
  vga->DrawLine(x + 1, y + 1, x + width - 2, y + 1, VGA_LIGHT_GRAY);
  vga->DrawLine(x + 1, y + 1, x + 1, y + height - 2, VGA_LIGHT_GRAY);
  vga->DrawLine(x + width - 2, y + 2, x + width - 2, y + height - 2,
                VGA_DARK_GRAY);
  vga->DrawLine(x + 2, y + height - 2, x + width - 2, y + height - 2,
                VGA_DARK_GRAY);

  // Center and draw label
  int32_t labelWidth = Font::GetStringWidth(label);
  int32_t labelX = x + (width - labelWidth) / 2;
  int32_t labelY = y + (height - 8) / 2;
  Font::DrawString(vga, labelX, labelY, label, textColor);
}

void Button::OnMouseDown(int32_t mx, int32_t my, uint8_t button) {
  if (Contains(mx, my)) {
    pressed = true;
  }
}

void Button::OnMouseUp(int32_t mx, int32_t my, uint8_t button) {
  if (pressed && Contains(mx, my)) {
    if (clickHandler)
      clickHandler();
  }
  pressed = false;
}

void Button::OnMouseMove(int32_t mx, int32_t my) { hovered = Contains(mx, my); }

void Button::SetClickHandler(void (*handler)()) { clickHandler = handler; }

// Label implementation
Label::Label(int32_t x, int32_t y, const char *text, uint8_t color)
    : Widget(x, y, Font::GetStringWidth(text), 8, 0) {
  this->text = text;
  this->textColor = color;
}

Label::~Label() {}

void Label::Draw(VideoGraphicsArray *vga) {
  if (!visible)
    return;
  Font::DrawString(vga, x, y, text, textColor);
}

void Label::SetText(const char *newText) {
  text = newText;
  width = Font::GetStringWidth(text);
}

// DesktopIcon implementation
DesktopIcon::DesktopIcon(int32_t x, int32_t y, const char *label,
                         uint8_t iconColor)
    : Widget(x, y, 48, 48, 0) {
  this->label = label;
  this->iconColor = iconColor;
  this->labelColor = VGA_WHITE;
  this->selected = false;
  this->doubleClickHandler = 0;
  this->lastClickTime = 0;
}

DesktopIcon::~DesktopIcon() {}

void DesktopIcon::DrawFolderIcon(VideoGraphicsArray *vga, int32_t ix,
                                 int32_t iy) {
  // Draw a simple folder icon (32x24 pixels)
  // Folder tab
  vga->FillRect(ix, iy, 12, 4, iconColor);
  // Folder body
  vga->FillRect(ix, iy + 4, 32, 20, iconColor);
  // Folder shadow/depth
  vga->DrawLine(ix + 1, iy + 5, ix + 30, iy + 5, VGA_YELLOW);
  // Border
  vga->DrawRect(ix, iy + 4, 32, 20, VGA_BROWN);
}

void DesktopIcon::Draw(VideoGraphicsArray *vga) {
  if (!visible)
    return;

  if (selected) {
    vga->FillRect(x - 2, y - 2, width + 4, height + 4, VGA_LIGHT_BLUE);
  }

  int32_t iconX = x + (width - 32) / 2;
  int32_t iconY = y + 2;
  DrawFolderIcon(vga, iconX, iconY);

  int32_t labelWidth = Font::GetStringWidth(label);
  int32_t labelX = x + (width - labelWidth) / 2;
  int32_t labelY = y + 30;
  Font::DrawString(vga, labelX, labelY, label, labelColor);
}

void DesktopIcon::OnMouseDown(int32_t mx, int32_t my, uint8_t button) {
  if (Contains(mx, my)) {
    selected = !selected;

    if (doubleClickHandler) {
      doubleClickHandler();
    }
  } else {
    selected = false;
  }
}

void DesktopIcon::SetDoubleClickHandler(void (*handler)()) {
  doubleClickHandler = handler;
}
